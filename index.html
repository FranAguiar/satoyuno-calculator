<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Satoyuno calculator</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121821;--muted:#92a2b6;--soft:#1a2330;--accent:#5dd4a3;--danger:#ff6b6b;--ring:#2b3a4b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--ring);background:linear-gradient(180deg,var(--panel),#0f141c);}
    header .title{font-weight:700;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    button{background:var(--soft);color:#e6eef8;border:1px solid var(--ring);padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    button:hover{filter:brightness(1.08)}
    .accent{background:var(--accent);color:#082016;border-color:#3dbd89}
    .danger{background:var(--danger);color:#2d0b0b;border-color:#e25a5a}
    main{padding:16px}
    .sheet{overflow:auto;border:1px solid var(--ring);border-radius:16px;background:var(--panel);}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:780px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#16202d,#0f1722);z-index:2}
    th,td{border-bottom:1px solid #1e2a38;padding:10px 12px;text-align:left}
    tbody tr:nth-child(odd) td{background:#0f1722}
    tbody tr:hover td{background:#122033}
    tfoot td{background:#0f1722;font-weight:700;border-top:2px solid #263447}
    th:first-child, td:first-child{position:sticky;left:0;background:inherit;z-index:1}
    th:first-child{background:linear-gradient(180deg,#16202d,#0f1722)}
    input[type="text"], input[type="number"]{width:100%;background:#0b111a;border:1px solid #233146;color:#e6eef8;border-radius:10px;padding:6px 8px}
    input[type="number"]{text-align:right}

    /* Encabezados de persona: papelera a la izquierda, nombre a la derecha */
    .nameHead{position:relative;display:flex;align-items:center;justify-content:flex-end;gap:8px}
    .personName{ text-align:right; padding-left:26px; }
    .delCol{
      position:absolute; left:4px; top:50%; transform:translateY(-50%);
      background:transparent; border:none; color:#99a8bb; cursor:pointer;
      font-size:16px; opacity:0; transition:opacity .2s;
    }
    .nameHead:hover .delCol,
    .personName:focus ~ .delCol,
    .delCol:hover{ opacity:1; color:#ffd7d7; }

    /* Celda de producto: papelera a la derecha */
    .prodCell{ position:relative; }
    .prodName{ padding-right:26px; } /* espacio para la papelera */
    .delRow{
      position:absolute; right:4px; top:50%; transform:translateY(-50%);
      background:transparent; border:none; color:#99a8bb; cursor:pointer;
      font-size:16px; opacity:0; transition:opacity .2s;
    }
    .prodCell:hover .delRow,
    .prodName:focus ~ .delRow,
    .delRow:hover{ opacity:1; color:#ffd7d7; }

    .cellBox{display:flex;align-items:center;gap:8px}
    .share{opacity:.8;font-size:.85em}
    .stickyFoot{position:sticky;bottom:0;}
    .muted{color:var(--muted)}
    .hint{font-size:.9em;color:var(--muted);margin-top:8px}
    .right{text-align:right}
    .center{text-align:center}
    .badge{font-size:.78em;background:#0b111a;border:1px solid #213043;border-radius:999px;padding:3px 8px;color:#b8c6d9}
    tfoot td.personTotal{padding-left:26px;} /* alinear con input de persona */

    /* Aviso de copiado */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0b111a; color:#e6eef8; border:1px solid #233146; padding:8px 12px;
      border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.35); opacity:0; pointer-events:none;
      transition:opacity .2s, transform .2s;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <header>
    <div class="title">üê∑ Satoyuno calculator <span class="badge">checkbox por persona/producto</span></div>
    <div class="controls">
      <button class="accent" id="addPerson">+ A√±adir persona</button>
      <button class="accent" id="addProduct">+ A√±adir producto</button>
      <button id="share">üîó Compartir</button>
      <button id="reset">‚Ü∫ Vaciar todo</button>
    </div>
  </header>

  <main>
    <div class="sheet">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>
    <p class="hint">Marca las casillas de quienes comparten cada producto. El coste se reparte a partes iguales entre las personas marcadas. Puedes editar nombres y precios directamente.</p>
  </main>

  <div id="toast" class="toast">¬°Link copiado!</div>

<script>
/******************** Estado ********************/
let people = []; // editable
let products = []; // {id, name, price, checked:{[personName]:boolean}}

/******************** Utiles ********************/
function id(){ return Math.random().toString(36).slice(2,9) }
const format = n => (Number.isFinite(n)? n.toLocaleString("es-ES", {minimumFractionDigits:2, maximumFractionDigits:2}) : "-");

/******************** Render ********************/
function render(){
  renderHead();
  renderBody();
  renderFoot();
}

function renderHead(){
  const ths = [
    `<th class="center" style="min-width:190px">Producto</th>`,
    `<th class="right" style="min-width:120px">Precio (‚Ç¨)</th>`
  ];
  people.forEach((nm,idx)=>{
    ths.push(
      `<th class="center">
        <div class="nameHead">
          <input data-col="${idx}" class="personName" type="text" value="${escapeHtml(nm)}"/>
          <button class="delCol" title="Eliminar persona" data-col-del="${idx}">üóëÔ∏è</button>
        </div>
      </th>`
    )
  });
  document.getElementById('thead').innerHTML = `<tr>${ths.join('')}</tr>`;
}

function renderBody(){
  const rows = products.map((p,ri)=>{
    const cells = [
      `<td class="prodCell">
         <input class="prodName" data-row="${ri}" type="text" value="${escapeHtml(p.name ?? '')}"/>
         <button class="delRow" title="Eliminar producto" data-row-del="${ri}">üóëÔ∏è</button>
       </td>`,
      `<td class="right"><input class="prodPrice" data-row="${ri}" type="number" min="0" step="0.01" value="${p.price ?? 0}"></td>`
    ];

    const activeCount = people.reduce((acc,nm)=> acc + (p.checked?.[nm]?1:0),0);

    people.forEach((nm,ci)=>{
      const on = !!(p.checked && p.checked[nm]);
      const share = on && activeCount>0 ? (+p.price||0)/activeCount : 0;
      cells.push(
        `<td class="center">
          <label style="display:flex;align-items:center;gap:8px;justify-content:center">
            <input class="chk" type="checkbox" data-row="${ri}" data-person="${ci}" ${on?"checked":""}/>
            <span class="share">${on?format(share):""}</span>
          </label>
        </td>`
      )
    });

    /* Conservamos el <td hidden> tal como en tu versi√≥n previa */
    return `<tr>${cells.join('')}<td hidden></td></tr>`;
  });
  document.getElementById('tbody').innerHTML = rows.join('');
}

function renderFoot(){
  const totals = calcTotals();
  const tds = [
    `<td class="right">Total</td>`,
    `<td class="right">${format(products.reduce((a,p)=>a+Number(p.price||0),0))}</td>`
  ];
  people.forEach(nm=>{
    tds.push(`<td class="right personTotal">${format(totals[nm]||0)}</td>`)
  });
  document.getElementById('tfoot').innerHTML = `<tr class="stickyFoot">${tds.join('')}</tr>`;
}

/******************** Logica ********************/
function calcTotals(){
  const totals = Object.fromEntries(people.map(nm=>[nm,0]));
  for(const p of products){
    const marked = people.filter(nm=>p.checked && p.checked[nm]);
    const n = marked.length;
    if(n>0){
      const share = (Number(p.price)||0)/n;
      marked.forEach(nm=> totals[nm]+=share);
    }
  }
  return totals;
}

/******************** Compartir por URL ********************/
function encodeState() {
  const state = { people, products };
  const json = JSON.stringify(state);
  return btoa(encodeURIComponent(json)); // base64 seguro
}
function decodeState(encoded) {
  try {
    const json = decodeURIComponent(atob(encoded));
    const state = JSON.parse(json);
    if (Array.isArray(state.people) && Array.isArray(state.products)) {
      people = state.people;
      products = state.products;
    }
  } catch (e) {
    console.error("Error al cargar datos desde la URL:", e);
  }
}
function updateShareLink() {
  const hash = encodeState();
  const newUrl = `${location.origin}${location.pathname}#data=${hash}`;
  history.replaceState(null, "", newUrl);
}
function loadFromUrl() {
  const m = location.hash.match(/data=([^&]+)/);
  if (m) decodeState(m[1]);
}
async function copyShareLink() {
  try {
    await navigator.clipboard.writeText(location.href);
    showToast("¬°Link copiado!");
  } catch {
    const tmp = document.createElement("input");
    tmp.value = location.href;
    document.body.appendChild(tmp);
    tmp.select(); document.execCommand("copy");
    tmp.remove();
    showToast("¬°Link copiado!");
  }
}
function showToast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.classList.remove('show'), 1500);
}

/* Hook: tras cada render, actualizamos el hash compartible */
const _render = render;
render = function(){ _render(); updateShareLink(); };

/******************** Eventos ********************/
const grid = document.getElementById('grid');
let oldPeople = [...people];

document.addEventListener('focusin',(e)=>{
  const t=e.target; if(t.classList.contains('personName')){ oldPeople=[...people]; }
});

grid.addEventListener('change',(e)=>{
  const t=e.target;
  if(t.classList.contains('chk')){
    const r = Number(t.dataset.row); const c = Number(t.dataset.person);
    const nm = people[c];
    products[r].checked = products[r].checked || {};
    products[r].checked[nm] = t.checked;
    render();
  }
});

grid.addEventListener('input',(e)=>{
  const t=e.target;
  if(t.classList.contains('prodName')){
    products[Number(t.dataset.row)].name = t.value;
    renderBody(); renderFoot(); updateShareLink();
  } else if(t.classList.contains('prodPrice')){
    products[Number(t.dataset.row)].price = parseFloat(t.value||0);
    renderBody(); renderFoot(); updateShareLink();
  } else if(t.classList.contains('personName')){
    const idx = Number(t.dataset.col);
    const prevName = oldPeople[idx];
    const newName = t.value.trim()||`Persona ${idx+1}`;
    products.forEach(p=>{
      p.checked = p.checked || {};
      if(Object.prototype.hasOwnProperty.call(p.checked, prevName)){
        p.checked[newName]=p.checked[prevName];
        delete p.checked[prevName];
      }
    });
    people[idx]=newName; oldPeople=[...people];
    render(); // updateShareLink se llama dentro
  }
});

// Borrar persona (columna)
grid.addEventListener('click',(e)=>{
  const btnCol = e.target.closest('[data-col-del]');
  if(btnCol){
    const idx = Number(btnCol.dataset.colDel);
    const name = people[idx];
    if(!confirm(`¬øQuitar a "${name}" de la hoja?`)) return;
    people.splice(idx,1);
    products.forEach(p=> { if(p.checked) delete p.checked[name]; });
    render();
    return;
  }

  // Borrar producto (fila)
  const btnRow = e.target.closest('[data-row-del]');
  if(btnRow){
    const ri = Number(btnRow.dataset.rowDel);
    const prodName = products[ri]?.name || 'producto';
    if(!confirm(`¬øEliminar "${prodName}"?`)) return;
    products.splice(ri,1);
    render();
  }
});

// Controles superiores
document.getElementById('addPerson').addEventListener('click',()=>{
  const nm = prompt('Nombre de la persona:','Nueva persona');
  if(nm===null) return; // cancel
  const name = nm.trim()||`Persona ${people.length+1}`;
  people.push(name);
  render();
});

document.getElementById('addProduct').addEventListener('click',()=>{
  const name = prompt('Nombre del producto:','Producto');
  if(name===null) return;
  const priceStr = prompt('Precio (‚Ç¨):','0');
  if(priceStr===null) return;
  const price = parseFloat((priceStr+'').replace(',','.'))||0;
  products.push({id:id(), name: name.trim()||'Producto', price, checked:{} });
  render();
});

document.getElementById('reset').addEventListener('click',()=>{
  if(!confirm('¬øSeguro que quieres vaciar todo?')) return;
  people = [];
  products = [];
  render();
});

document.getElementById('share').addEventListener('click', copyShareLink);

/******************** Helpers ********************/
function escapeHtml(str){
  return (str+"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s]));
}

/* Inicial: cargar desde URL si existe, y luego render (que actualizar√° el hash) */
loadFromUrl();
render();
</script>
</body>
</html>
